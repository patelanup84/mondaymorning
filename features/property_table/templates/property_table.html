<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Table - MondayMorning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sort-link { color: inherit; text-decoration: none; }
        .sort-link:hover { color: #0d6efd; }
        .sort-icon { font-size: 0.8em; color: #6c757d; }
        .feature-badge { margin: 2px; }
        .img-thumbnail-sm { width: 80px; height: 80px; object-fit: cover; }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">MondayMorning</span>
        </div>
    </nav>

    <!-- Page Title -->
    <div class="bg-light border-bottom py-3">
        <div class="container-fluid">
            <h2 class="mb-0">Property Table</h2>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border-bottom py-3">
        <div class="container-fluid">
            <form method="GET" action="{{ url_for('property_table.list_properties') }}">
                <div class="row g-3">
                    <!-- Competitor Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Competitor</label>
                        <select name="competitor" class="form-select" multiple size="3">
                            {% for comp in filter_options.competitors %}
                            <option value="{{ comp.id }}" 
                                {% if comp.id in filters_applied.competitors %}selected{% endif %}>
                                {{ comp.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Community Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Community</label>
                        <select name="community" class="form-select" multiple size="3">
                            {% for comm in filter_options.communities %}
                            <option value="{{ comm }}" 
                                {% if comm in filters_applied.communities %}selected{% endif %}>
                                {{ comm }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Price Min -->
                    <div class="col-md-2">
                        <label class="form-label">Price Min</label>
                        <input type="number" name="price_min" class="form-control" 
                               placeholder="$400,000" 
                               value="{{ filters_applied.price_range[0] if filters_applied.price_range else '' }}">
                    </div>

                    <!-- Price Max -->
                    <div class="col-md-2">
                        <label class="form-label">Price Max</label>
                        <input type="number" name="price_max" class="form-control" 
                               placeholder="$800,000"
                               value="{{ filters_applied.price_range[1] if filters_applied.price_range else '' }}">
                    </div>

                    <!-- Search Address -->
                    <div class="col-md-2">
                        <label class="form-label">Search Address</label>
                        <input type="text" name="search_address" class="form-control" 
                               placeholder="Main St"
                               value="{{ filters_applied.search_address or '' }}">
                    </div>

                    <!-- Search Features -->
                    <div class="col-md-2">
                        <label class="form-label">Search Features</label>
                        <input type="text" name="search_features" class="form-control" 
                               placeholder="Granite, Stainless"
                               value="{{ filters_applied.search_features or '' }}">
                    </div>
                </div>

                <!-- Hidden sort fields to maintain sort state -->
                <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
                <input type="hidden" name="sort_order" value="{{ current_sort_order }}">

                <!-- Apply Button -->
                <div class="row mt-3">
                    <div class="col">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="{{ url_for('property_table.list_properties') }}" class="btn btn-secondary">Clear</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Info -->
    <div class="bg-light py-2">
        <div class="container-fluid">
            <small class="text-muted">
                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }}-{{ 
                    [pagination.page * pagination.per_page, pagination.total]|min 
                }} of {{ pagination.total }} properties
            </small>
        </div>
    </div>

    <!-- Table -->
    <div class="container-fluid py-3">
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Image</th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='competitor_id',
                                sort_order='asc' if current_sort_by == 'competitor_id' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Competitor
                                {% if current_sort_by == 'competitor_id' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='community',
                                sort_order='asc' if current_sort_by == 'community' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Community
                                {% if current_sort_by == 'community' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>Address</th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='price',
                                sort_order='asc' if current_sort_by == 'price' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Price
                                {% if current_sort_by == 'price' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='sqft',
                                sort_order='asc' if current_sort_by == 'sqft' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Sq Ft
                                {% if current_sort_by == 'sqft' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>$/Sq Ft</th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='beds',
                                sort_order='asc' if current_sort_by == 'beds' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Beds
                                {% if current_sort_by == 'beds' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ url_for('property_table.list_properties', 
                                competitor=filters_applied.competitors,
                                community=filters_applied.communities,
                                price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                                price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                                search_address=filters_applied.search_address,
                                search_features=filters_applied.search_features,
                                sort_by='baths',
                                sort_order='asc' if current_sort_by == 'baths' and current_sort_order == 'desc' else 'desc',
                                page=pagination.page
                            ) }}" class="sort-link">
                                Baths
                                {% if current_sort_by == 'baths' %}
                                    <span class="sort-icon">{{ '▲' if current_sort_order == 'asc' else '▼' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        <th>Features</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prop in properties %}
                    <tr>
                        <td>
                            {% if prop.image_url %}
                            <img src="{{ prop.image_url }}" class="img-thumbnail img-thumbnail-sm" alt="Property">
                            {% else %}
                            <div class="img-thumbnail img-thumbnail-sm bg-light d-flex align-items-center justify-content-center">
                                <small class="text-muted">No Image</small>
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ prop.competitor }}</td>
                        <td>{{ prop.community }}</td>
                        <td><a href="{{ prop.url }}" target="_blank">{{ prop.address }} ↗</a></td>
                        <td>{{ prop.price_formatted }}</td>
                        <td>{{ prop.sqft_formatted }}</td>
                        <td>{{ prop.price_per_sqft_formatted }}</td>
                        <td>{{ prop.beds }}</td>
                        <td>{{ prop.baths }}</td>
                        <td>
                            {% for feature in prop.features[:5] %}
                            <span class="badge bg-secondary feature-badge">{{ feature }}</span>
                            {% endfor %}
                            {% if prop.features|length > 5 %}
                            <span class="badge bg-light text-dark">+{{ prop.features|length - 5 }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            No properties found. Try adjusting your filters.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="container-fluid pb-4">
        <nav>
            <ul class="pagination justify-content-center">
                <!-- Previous -->
                <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('property_table.list_properties',
                        competitor=filters_applied.competitors,
                        community=filters_applied.communities,
                        price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                        price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                        search_address=filters_applied.search_address,
                        search_features=filters_applied.search_features,
                        sort_by=current_sort_by,
                        sort_order=current_sort_order,
                        page=pagination.page - 1
                    ) }}">◄ Prev</a>
                </li>

                <!-- Page numbers -->
                {% for p in range(1, pagination.total_pages + 1) %}
                    {% if p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                    <li class="page-item {% if p == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('property_table.list_properties',
                            competitor=filters_applied.competitors,
                            community=filters_applied.communities,
                            price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                            price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                            search_address=filters_applied.search_address,
                            search_features=filters_applied.search_features,
                            sort_by=current_sort_by,
                            sort_order=current_sort_order,
                            page=p
                        ) }}">{{ p }}</a>
                    </li>
                    {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                <!-- Next -->
                <li class="page-item {% if pagination.page == pagination.total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('property_table.list_properties',
                        competitor=filters_applied.competitors,
                        community=filters_applied.communities,
                        price_min=filters_applied.price_range[0] if filters_applied.price_range else '',
                        price_max=filters_applied.price_range[1] if filters_applied.price_range else '',
                        search_address=filters_applied.search_address,
                        search_features=filters_applied.search_features,
                        sort_by=current_sort_by,
                        sort_order=current_sort_order,
                        page=pagination.page + 1
                    ) }}">Next ►</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
